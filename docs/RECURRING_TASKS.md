# 繰り返しタスク機能

このドキュメントは、Personal Hubアプリケーションの繰り返しタスク機能について説明します。

## 概要

繰り返しタスク機能では、定期的に実行されるタスクを設定・管理できます。バックエンドで既に実装済みのAPIを活用し、フロントエンドで直感的なユーザーインターフェースを提供します。

## 機能

### 1. 繰り返しタスクの作成

TODOフォームで繰り返し設定を有効にすることで、以下のパターンで繰り返しタスクを作成できます：

- **毎日**: 指定した間隔（日数）で繰り返し
- **毎週**: 指定した曜日に繰り返し（複数選択可能）
- **毎月**: 指定した日付に繰り返し
- **毎年**: 指定した日付に毎年繰り返し

#### 設定項目

- **繰り返しパターン**: DAILY/WEEKLY/MONTHLY/YEARLY
- **間隔**: 繰り返しの間隔（例：2日おき、3週おき）
- **曜日選択**: 週次繰り返しの場合のみ（複数選択可能）
- **月の日付**: 月次繰り返しの場合のみ
- **終了日**: 繰り返しを停止する日付（任意）

### 2. 繰り返しタスク管理画面

専用の管理画面（`/recurring-tasks`）では以下の操作が可能です：

- 作成済み繰り返しタスクの一覧表示
- 各タスクの繰り返し設定の確認
- インスタンス（自動生成されたタスク）の表示
- 手動でのインスタンス生成

### 3. インスタンス管理

繰り返しタスクから自動生成されたタスクインスタンスを確認できます：

- 生成済みインスタンスの一覧表示
- 各インスタンスのステータス（TODO/IN_PROGRESS/DONE）
- インスタンスごとの期限日
- 元の繰り返しタスクとの関連性表示

### 4. 既存TODOリストとの統合

通常のTODOリスト画面でも繰り返しタスクが識別できます：

- 繰り返しタスクには🔄アイコンが表示
- インスタンスには🔗アイコンが表示
- 元タスクとの関連がツールチップで確認可能

## 技術仕様

### API エンドポイント

フロントエンドでは以下のバックエンドAPIを使用：

- `POST /api/v1/todos` - 繰り返しタスク作成
- `GET /api/v1/todos/repeatable` - 繰り返し設定有効タスク一覧
- `GET /api/v1/todos/{id}/instances` - 特定タスクのインスタンス一覧
- `POST /api/v1/todos/repeat/generate` - インスタンス手動生成

### データ型

```typescript
export interface RepeatConfig {
  repeatType: 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'YEARLY' | 'ONCE';
  interval?: number;
  daysOfWeek?: number[] | null;
  dayOfMonth?: number | null;
  endDate?: string | null;
}

export interface Todo {
  // ... 既存フィールド
  isRepeatable?: boolean;
  repeatConfig?: RepeatConfig | null;
  originalTodoId?: number | null;
}
```

### コンポーネント構成

```
src/
├── components/
│   ├── TodoForm.tsx              # 繰り返し設定追加済み
│   └── TodoItem.tsx              # アイコン表示対応
├── app/
│   └── recurring-tasks/
│       ├── page.tsx              # 管理画面
│       └── __tests__/            # テスト
├── lib/
│   └── api.ts                    # API関数追加
└── types/
    └── todo.ts                   # 型定義更新
```

## 使用方法

### 繰り返しタスクの作成

1. TODOページで「新しいタスクを作成」をクリック
2. 基本情報（タイトル、説明、優先度等）を入力
3. 「繰り返しタスク」チェックボックスを有効化
4. 繰り返しパターンと詳細設定を選択
5. 「繰り返しタスクを作成」をクリック

### 管理画面での操作

1. サイドバーから「繰り返しタスク」をクリック
2. 作成済みタスクの一覧を確認
3. 「インスタンスを表示」でタスクインスタンスを確認
4. 「インスタンス生成」で手動生成を実行

### 設定例

#### 毎日の運動
- パターン: 毎日
- 間隔: 1日おき
- 終了日: なし

#### 週3回のジム
- パターン: 毎週
- 間隔: 1週おき
- 曜日: 月・水・金
- 終了日: なし

#### 月末レポート
- パターン: 毎月
- 間隔: 1ヶ月おき
- 日付: 31日
- 終了日: 2025年12月31日

## テスト

### 単体テスト

- `TodoForm.recurring.test.tsx`: フォームの繰り返し設定機能
- `api.recurring.test.ts`: API関数のテスト
- `page.test.tsx`: 管理画面のテスト

### 統合テスト

- `integration.test.tsx`: エンドツーエンドのワークフローテスト

### テスト実行

```bash
# 単体テスト
npm test TodoForm.recurring
npm test api.recurring
npm test page.test

# 統合テスト
npm test integration.test

# 全テスト
npm test
```

## 今後の拡張予定

1. **テンプレート機能**: よく使用される繰り返しパターンのテンプレート
2. **通知機能**: インスタンス生成時やタスク期限の通知
3. **カレンダー連携**: カレンダー画面での繰り返しタスク表示
4. **統計機能**: 繰り返しタスクの完了率や傾向分析
5. **一括操作**: 複数インスタンスの一括ステータス変更

## トラブルシューティング

### よくある問題

1. **インスタンスが生成されない**
   - バックエンドサーバーが起動していることを確認
   - 繰り返し設定が正しく保存されているか確認

2. **曜日選択が保存されない**
   - WEEKLY選択時に少なくとも1つの曜日を選択
   - 日曜日は「7」として扱われることに注意

3. **月次設定で日付が無効**
   - 月によって存在しない日付（例：2月31日）は避ける
   - 月末を指定したい場合は31日を設定

### デバッグ

1. ブラウザの開発者ツールでAPIリクエストを確認
2. コンソールエラーをチェック
3. バックエンドログを確認

## 参考資料

- [バックエンドAPI仕様書](../../personal-hub-backend/docs/API.md#繰り返しtodoエンドポイント認証必須)
- [React Hook Form公式ドキュメント](https://react-hook-form.com/)
- [TanStack Query公式ドキュメント](https://tanstack.com/query/latest)